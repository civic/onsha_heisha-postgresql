II. SQL言語 第8章 データ型
==================

### 8.15 配列

組み込み型やユーザ定義型などの配列が列の型として定義できる

- 中括弧で配列リテラルが使用可能
    - `'{Apple, Orange, Banana}'`
- ARRAY構文の方が直感的かも
    -`ARRAY['Apple', 'Orange', 'Banana']`

**注意**

> 配列は集合ではありません。 特定の配列要素に検索をかけることはデータベース設計が誤っている可能性があります。 配列の要素とみなされるそれぞれの項目を行に持つ別のテーブルを使うことを検討してください。 この方が検索がより簡単になり要素数が大きくなっても規模的拡張性があります。

jsonの時と同じようにtagとかユーザが変更可能な属性など？


### 8.16 複合型

- テーブルの行のみたいなもの。構造体のようなもの。
- テーブルと同じように作る
    - `CREATE TYPE hoge AS ...`
- ROW構文で複合型のデータを作成
    - リテラルでもできるが複雑
- 複合型の構成要素にアクセスする場合は()で囲んでから.で属性指定する。
    - テーブル名指定の構文と競合するので()は省略できない
    - `(complex_type).field`
    - `(table_name.complex_type).field`


別のテーブルとして定義したほうがよいが、塊として意味をもつ構造を持ったデータを表現したい時によいかも。


#### 練習 8-4

複合型「地図表示位置(map_view_pos)を作成する。

- 次の3つをセットにする複合型(map_view_pos)を作成
    - 緯度(latitude) numeric
    - 経度(longitude) numeric
    - ズーム位置(zoom) integer
- 地名と地図における表示位置を格納するテーブル placesを作成
    - 地名(name) text
    - 地図表示位置(pos) map_view_pos
- 3件のデータを追加
    - 新潟駅 (37.9068379,139.0573775,16)
    - 長岡市 (37.4435243,138.6035752,10)
    - ニューヨーク(39.953089,-75.0634726,8)
- 緯度が北緯38度以下のレコードを表示

### 8.17 範囲型

順序を持つデータの開始と終了を表すデータ。

- 数値
    - int4range
    - int8range
    - numrange
- タイムスタンプ
    - tsrange
    - tstzrange
- 日付
    - daterange

#### 各種演算子・関数

含有
```
        10          20
         +-----------o  10以上20未満
    ^           ^
    3           16

SELECT int4range(10, 20) @> 3;
    -> f
SELECT int4range(10, 20) @> 16;
    -> t


```

重なり
```
        11.1        22.2
         +-----------o  
                +----------o
              20.0        30.0
        
SELECT numrange(11.1, 22.2) && numrange(20.0, 30.0)
    -> t

```

重なりのパターンについて考える。　開始終了の2値をもつ場合の条件
```
            from    to
             +------o
    -   +--o
    t   +------o
    t   +--------------o
    t          +--o
    t          +------o
    -                 +----o
               
```

上限の取得

```
SELECT upper(int8range(15, 25)) 
    -> 25
```

共通部分の取得
```
        10          20  
         +-----------o  
               +----------o
              15          25 
               +=====o

SELECT int4range(10, 20) * int4range(15, 25);
    -> [15, 20)
-- 15以上[ 20未満 )
```

範囲は空か
```
SELECT isempty(numrange(1, 5));
    -> f
SELECT isempty(int4range(10, 20) * int4range(15, 25));
    -> f
SELECT isempty(int4range(10, 20) * int4range(15, 25));
    -> t

```

#### 8.17.3 閉じた境界と開いた境界

- 閉じた境界：値を含む  (以上、以下)
    - `[`   以上
    - `]`   以下
- 開いた境界：値を含まない  (より大きい、未満)
    - `(`   より大きい
    - `)`   未満

#### 8.17.5 範囲の入出力

- 文字列で書いて型指定
    - SELECT `[3, 7)`::int4range
- ただし離散的な範囲は正規化される(後述)

#### 8.17.6 範囲の生成

- コンストラクタ関数
    - `int4range(10, 20)`
    - ここでの`()`は関数呼び出しで境界の指定と混同しないように
    - 境界は第3引数で指定
        - `int4range(10, 20, `[]`)`
        - ただし離散的な範囲は正規化される(後述)

#### 8.17.7 離散的な範囲型

- integerやdateなどの連続しない範囲
- 整数範囲において、1以上5以下`[1, 5]`と1以上6未満`[1,6)`は同じ
- 組み込み範囲の整数、日付は閉じた下限と開いた上限に正規化される

#### 8.17.8 新しい範囲型の定義

- `CREATE TYPE ... AS RANGE`
- 差分関数や正規化関数を用意して新しい範囲型を作成できる

#### 8.17.9 インデックス

インデックスがあると範囲演算子を含む検索が高速になる

#### 8.17.10 制約

- 排他制約が便利に使える
    - 例:予約時間の範囲がかぶってない


#### 練習 8-5

予約テーブルを作成し、予約時間を排他的にする。

- ドキュメントにあるreservationを作成する。

- ドキュメントにあるroom_reservationを作成する。

btree_gist extensionをインストールする。
```
cd postgresql-9.6.1/contrib/bree_gist
make
sudo make install
```

### 8.18 オブジェクト識別子データ型
### 8.19 pg_lsn型
### 8.20 擬似データ型

省略


